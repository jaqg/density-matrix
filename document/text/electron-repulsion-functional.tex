%-----------------------------------------------
\section{Electron repulsion functional} % (fold)
\label{sub:Electron-electron functionals}
%-----------------------------------------------

In most approximations proposed so far, $E_{\text{ee}} \left[ \fordm \right]$
is an explicit function of the occupation numbers and the natural spin-orbitals. 

% subsection Electron-electron functionals (end)
There are two cases where the exact forms of $\func{E_{\text{ee}}}{\fordm}$ are known:
\begin{enumerate}
    \item \textbf{$n$-electron noninteracting systems}: the 1-RDM corresponding
        to a single determinant wavefunction is idempotent, which implies integer
        (0 or 1) values of the natural occupation numbers 
        \begin{equation}
            \hat{\fordm}^{2} = \hat{\fordm}
            \Leftrightarrow
            n_p = 0  \vee n_p = 1
            \quad \forall_{p}
            .
        \end{equation}

        In this case, a 2-RDM is defined for a general wavefunction, $\Psi$, as 
        \begin{equation}
            \sordm \left( \mat{x}_1, \mat{x}_2, \mat{x}_1\myprime, \mat{x}_2\myprime \right)
            =
            n\left( n - 1 \right) \idotsint
            \Psi \left( \mat{x}_1, \mat{x}_2, \mat{x}_3, \ldots,  \mat{x}_n \right)
            \Psi^{*} \left( \mat{x}_1\myprime, \mat{x}_2\myprime, \mat{x}_3, \ldots,  \mat{x}_n \right)
            \dd{ \mat{x}_3} \cdots \dd{ \mat{x}_n}
            ,
        \end{equation}
        which is explicitly expressible in terms of 1-RDM if the wavefunction takes
        the form of a Slater determinant 
        \begin{equation} \label{eq:HF-approximation-sordm-1}
            \sordm \left( \mat{x}_1, \mat{x}_2, \mat{x}_1\myprime, \mat{x}_2\myprime \right)
            = 
            \fordm \left( \mat{x}_1, \mat{x}_1\myprime \right)
            \fordm \left( \mat{x}_2, \mat{x}_2\myprime \right)
            -
            \fordm \left( \mat{x}_1, \mat{x}_2\myprime \right)
            \fordm \left( \mat{x}_2, \mat{x}_1\myprime \right)
            .
        \end{equation}

        The electron interaction functional corresponding to such a
        noninteracting 2-RDM reads 
        \begin{equation}
            \func{E_{\text{ee}}^{\text{HF}}}{\fordm} =
            \func{E_{\text{H}}}{\fordm} + \func{E_{\text{x}}}{\fordm}
            ,
        \end{equation}
        % refered to as the Hartree-Fock functional, because the optimization of
        % the functional leads to an idempotent density matrix coinciding with
        % the solution to the HF equations\mycite{lieb1981variational}.
        referred to as the Hartree-Fock functional as the HF equations' 
        solution coincides with an idempotent density matrix that results 
        from functional optimization\mycite{lieb1981variational}.
        The Hartree functional, $E_{\text{H}}$, describes the classical
        part of electron interaction 
        \begin{equation}
            \func{E_{\text{H}}}{\fordm} = \frac{1}{2} \iint
            \frac{
                \fordm \left( \mat{x}, \mat{x} \right)
                \fordm \left( \mat{x}\myprime, \mat{x}\myprime \right)
            }{\left| \mat{r} - \mat{r}\myprime \right|}
            \dd{ \mat{x}} \dd{ \mat{x}\myprime}
            ,
        \end{equation}
        whereas the exchange functional, $E_{\text{x}}$, reads 
        \begin{equation}
            \func{E_{\text{x}}}{\fordm} = -\frac{1}{2} \iint
            \frac{
                \fordm \left( \mat{x}, \mat{x}\myprime \right)
                \fordm \left( \mat{x}\myprime, \mat{x} \right)
            }{\left| \mat{r} - \mat{r}\myprime \right|}
            \dd{ \mat{x}} \dd{ \mat{x}\myprime}
            .
        \end{equation}
        % Recalling the Hartree-Fock approximation given in \cref{eq:HF-approximation-sordm-1},
        % in which $\sordm$ in the representation of the natural spin-orbitals is given
        % solely in terms of the occupation numbers 
        Using the Hartree-Fock approximation stated in \cref{eq:HF-approximation-sordm-1},
        where $\sordm$ in the representation of the natural spin-orbitals is given 
        solely in terms of the occupation numbers
        \begin{equation}
            \sordm_{pqrs}^{\text{HF}}
            =
            n_p n_q \left( \delta_{pr} \delta_{qs} - \delta_{ps} \delta_{qr} \right)
            ,
        \end{equation}
        % and making the assumption that the elements of $\sordm$ are functions of the natural occupation
        % numbers, $\left\{ n_p \right\}$, and the basis set is composed of natural 
        % spin-orbitals, $\left\{ \varphi_p \right\}$, the whole dependence of $E_{\text{ee}}$ 
        % on $\varphi_p$ is included in two-electron integrals.
        and assuming that the elements of $\sordm$ are functions of the natural 
        occupation numbers, $\left\{ n_p \right\}$, and the basis set is formed by 
        natural spin-orbitals, $\left\{ \varphi_p \right\}$, the entire dependence of
        $E_{\text{ee}}$ on $\varphi_p$ is included in two-electron integrals.

    \item \textbf{Two-electron closed-shell system}: an interacting two-electron
        species.

        % (see sec 2.1 of Pernal)
        The exact density matrix functional for a two-electron system is
        known\mycite{goedecker1998natural, kutzelnigg1963loesung}.

        Based on the work of LÃ¶wdin and Shull (LS)\mycite{shull1956correlation},
        a Slater-determinant-expansion of a singlet wavefunction (assumed to be
        real-valued) in the natural spin-orbitals basis $\left\{ \varphi_p \right\}$ 
        is entirely given by \textit{diagonal} determinants composed of the
        spin-orbitals that share spatial parts 
        \begin{equation}
            \psi^{\text{LS}} =
            \sum_{p} c_p \left| \varphi_p \varphi_{\bar{p}} \right|
            ,
        \end{equation}
        % where $p$ and $\bar{p}$ are spin-orbitals of the opposite spin and
        % $\left| \varphi_p \varphi_{\bar{p}} \right|$ denotes a normalized
        % Slater determinant.
        where $\left| \varphi_p \varphi_{\bar{p}} \right|$ indicates a 
        normalized Slater determinant and $p$ and $\bar{p}$ are
        spin-orbitals of opposite spin.
        The normalization of $\psi^{\text{LS}}$ imposes
        that $\displaystyle\sum_{p} c_p^{2} = 1$.

        % The 1-RDM given by this wavefunction is directly in its spectral
        % representation, which indicates that squares of the expansion
        % coefficients are simply the natural occupation numbers 
        This wavefunction provides the 1-RDM directly in its spectral 
        representation, implying that the squares of the expansion 
        coefficients are just the natural occupation numbers
        \begin{equation}
            n_p = c_p^2\quad \forall_p
            .
        \end{equation}

        The energy is given by 
        \begin{equation}
            E = \Braket{\psi^{\text{LS}} | \hat{H} | \psi^{\text{LS}}} =
            \sum_{p} c_p^2 h_{pp} + \frac{1}{2} \sum_{pq} 
            c_p c_q \Braket{pp | qq}
            ,
        \end{equation}
        assuming that the coefficients corresponding to spin-orbitals of opposite
        spins and same spatial parts are equal.

        By minimizing the energy with respecto to $\left\{ c_p \right\}$ and
        $\left\{ \varphi_p \right\}$, an exact electron interaction density
        matrix functional can be immediately written as 
        \begin{equation} \label{eq:LS-functional}
            E_{\text{ee}}^{\text{LS}} \left[ \fordm \right] =
            \frac{1}{2} \min_{ \left\{ f_q \right\}} \sum_{pq}
            f_p f_q \sqrt{n_p n_q} \Braket{pq | qp}
            ,
        \end{equation}
        with 
        \begin{equation}
            f_p = \pm 1\quad \forall_p
            ,
        \end{equation}
        and $ \Braket{pp | qq} = \Braket{pq | qp}$, as the orbitals are real.

        % It is known that for two-electron atoms and molecules at equilibrium
        % geometry the sign of the factor $f_1$ corresponding to the highest
        % occupation $n_1$ is predominantly opposite to signs
        % $\left\{ f_p \right\}$ of all other factors corresponding to weakly
        % occupied $\left( n_p < \frac{1}{2} \right)$ orbitals\mycite{goedecker1998natural}.
        For two-electron atoms and molecules in equilibrium geometry, it is 
        known that the sign of the factor $f_1$ corresponding to the highest 
        occupation $n_1$ is predominantly opposite to the signs of all other 
        factors corresponding to weakly occupied $\left( n_p < \frac{1}{2} \right)$
        orbitals\mycite{goedecker1998natural}.

        % There are known cases when this rule is violated\mycite{goedecker1998natural, sheng2013natural, giesbertz2013longrange, cioslowski2000ground},
        % in which a two-electron functional explicitly depending on the occupation
        % noumbers is defined as 
        There are known cases when this condition is violated\mycite{goedecker1998natural, sheng2013natural, giesbertz2013longrange, 
        cioslowski2000ground}, in which a two-electron functional that depends 
        explicitly on the occupation numbers is defined as
        \begin{equation}
            \tilde{E}_{\text{ee}}^{\text{LS}} \left[ \fordm \right] =
            \frac{1}{2} \sum_{pq}  G_{pq}^{\text{LS}} \Braket{pq | qp},
        \end{equation}
        with 
        \begin{equation}
            G_{pq}^{\text{LS}} =
            \begin{cases}
                n_p & p = q \\
                - \sqrt{n_p n_q} & p = 1,\ q > 1\ \mathrm{or}\ p>1,\ q=1 \\
                \sqrt{n_p n_q} & \text{otherwise}
            \end{cases}
            ,
        \end{equation}
        which, although not always fully equivalent to the exact LS functional
        given in \cref{eq:LS-functional}, is a good approximation.

        % Also, the LS functional was extended for the more general closed-shell
        % $n$ (even) electron ansatz involving all determinants arising from
        % diagonal double, diagonal quadruple, etc. excitations.
        % %
        % The extended LÃ¶wdin-Shull (ELS) functional\mycite{pernal2004phase, mentel2014density}
        % is applicable to systems for which a set of
        % the natural spin-orbitals can be partitioned into \textit{inner} orbitals
        % localized on atoms and the occupancies close to 1, and \textit{outer}
        % orbitals including a bonding orbital and all weakly occupied orbitals.
        % % eq 44 y 45 del Pernal
        % It has been designed to treat only molecules with one single bond and no 
        % lone pairs, aiming at providing a balanced description of the dynamic
        % and static correlation.
        Additionally, the LS functional has been extended to include all 
        determinants resulting from diagonal double, diagonal quadruple, etc. 
        excitations in the more general closed-shell $n$ (even) electron ansatz.
        %
        For systems for which a set of the natural spin-orbitals can be divided 
        into \textit{inner} orbitals, which are localized on atoms and have 
        occupancies close to 1, and \textit{outer} orbitals, which include a 
        bonding orbital and all weakly occupied orbitals, the extended LÃ¶wdin-
        Shull (ELS) functional\mycite{pernal2004phase, mentel2014density} is 
        applicable.
        %eq 44 and 45 of the Pernal
        In order to provide a balanced description of the dynamic and static 
        correlation, it has been developed to treat only molecules with a 
        single bond and no lone pairs.

\end{enumerate}

Therefore, exact density matrix functionals for an uncorrelated and a strongly
correlated electron pair are known.

% ------------------------------
\subsection{Approximations for $E_{\text{ee}}$} % (fold)
% ------------------------------

% subsection \subsection{Approximations for $E_{\text{ee}}$} % (fold)
The first approximate density matrix functional was developed by MÃ¼ller\mycite{muller1984explicit}
and, independently, by Buijse and Baerends \mycite{buijse2002approximate, buijse1991electron}.
It was later corrected resulting in the BB-corrected (BBC) functionals\mycite{gritsenko2005improved}
\begin{equation}
    E_{\text{ee}}^{\text{BBC}}\left[ \fordm \right] =
    \frac{1}{2} \sum_{pq} n_p n_q \Braket{pp | qq} +
    \frac{1}{2} \sum_{pq} G_{pq}^{\text{BBC}} \Braket{pq | qp}
    ,
\end{equation}
where the $G_{pq}^{\text{BBC}}$ factor of the exchange-correlation functional
depends on the occupation numbers.
The first correction reads
\begin{equation}
    G_{pq}^{\text{BBC1}} = 
    \begin{cases}
        \sqrt{n_p n_q} & p \not= q \wedge p,q \in W, \\
        -\sqrt{n_p n_q} & \text{otherwise}, \\
    \end{cases}
\end{equation}
where $p,q \in W$ means that the spin-orbitals $p,q$ belong to the set of weakly
occupied spin-orbitals, i.e. 
orbitals with $n_p < \frac{1}{2}$ and $n_q < \frac{1}{2}$, and
$p,q \in S$ refer to strongly occupied spin-orbitals for
$n_p, n_q > \frac{1}{2}$.
The symbol $\wedge$ stands for the logical \textit{and}.

The drawback of the BBC1 functional is that it overbinds diatomic molecules,
indicating a need for further repulsive corrections\mycite{gritsenko2005improved}.

The BBC2 functional improved BBC1 by addressing the interaction between two
strongly occupied orbitals as
\begin{equation}
    G_{pq}^{\text{BBC2}} = 
    \begin{cases}
        \sqrt{n_p n_q} & p \not= q \wedge p,q \in W, \\
        -n_p n_q & p \not= q \wedge p,q \in S, \\
        -\sqrt{n_p n_q} & \text{otherwise}, \\
    \end{cases}
\end{equation}

In the BBC3 functional, corrections were included for the interaction between a pair 
of bonding and antibonding (frontier) spinorbitals.
Additionally, BBC3 eliminated self-interaction effects from all orbitals except
the frontier ones.
\begin{equation}
    G_{pq}^{\text{BBC3}} =
    \begin{cases}
        \sqrt{n_p n_q} &
        p\not=q \wedge p,q \in W,
        \\
        %
        \sqrt{n_p n_q} &
        \left( p \in W \wedge q \in F_W \right) \vee
        \left( p \in F_W \wedge q \in W \right),
        \\
        %
        -n_p n_q &
        p\not=q \wedge p,q \in S,
        \\
        %
        -n_p n_q &
        \left( p \in S \wedge q \in F \right) \vee
        \left( p \in F \wedge q \in S \right),
        \\
        %
        -n_p^{2} & p=q \wedge p\not\in F, \\
        - \sqrt{n_p n_q} & \text{otherwise},
    \end{cases}
\end{equation}
where $p \in F_W$ refers to a weakly occupied frontier orbital.
The symbol $\vee$ stands for the logical \textit{or}.

Over the practical difficulty of the need to select bonding and antibonding
orbitals, BBC3 accounts for both dynamic and static correlation, providing 
accurate potential energy and recovering most of the correlation energy. 
This practical difficulty has been addressed by attempting to automate it with
functions such as AC3 proposed by Rohr \textit{et al.}\mycite{rohr2008density}.

One found issue is that, when applied to systems with large number of
electrons, there is the possibility of degenerate bonding and antibonding
orbitals which, if selected as bonding or antibonding, break the symmetry
of the molecule.
In order to avoid this issue, the modification by Lathiotakis and 
Marques\mycite{lathiotakis2008benchmark} is used here.
The $S$ set is subdivided into
two subsets: the subset $S_b$ for the degenerate bonding orbitals and the subset
$S_c$ for the rest. The $W$ set is subdivided into $W_a$ for the degenerate
antibonding orbitals and $W_h$ for the rest weakly occupied orbitals
\begin{equation}
    G_{pq}^{\text{BBC3}} = 
    \begin{cases}
        \sqrt{n_p n_q} & p \not= q \wedge p,q \in W, \\
        -n_p n_q & p \not= q \wedge p,q \in S, \\
        -n_p n_q & \left( p \in S_c \wedge q \in W_a \right) \vee \left( p \in W_a \wedge q \in S_c \right), \\
        -n_p^{2} & p \not= q \wedge p,q \in S_c \cup W_h, \\
        -\sqrt{n_p n_q} & \text{otherwise}, \\
    \end{cases}
\end{equation}
where the symbol $\cup$ stands for the union of two sets.

% ---------
\subsection{Construction of 2-RDM in terms of 1-RDM}
% seccion 2.2 Pernal
% ---------

% There is a variety of
% conditions to be imposed on the 2-RDM which may aid in its
% construction\mycite{cioslowski2002systematic}

Assuming the cumulant expansion of 2-RDM\mycite{staroverov2002optimization} which
consists of writing $\sordm$ as the antisymmetrized product of $\fordm$ and
the cumulant part, $\lambda$, being a functional of $\fordm$ 
\begin{equation}
    \sordm_{pqrs} =
    n_p n_q \left( \delta_{pr} \delta_{qs} - \delta_{ps} \delta_{qr} \right)
    + \lambda_{pqrs} \left[ \fordm \right]
    ,
\end{equation}
one-electron density matrix functionals can be developed by finding
approximations for the cumulant part imposing known conditions which the exact
cumulant satisfies.

\textcolor{red}{(\ldots)}

\textcolor{red}{Duda: pairs of coupled orbitals para implementar PNOF$i$}

\textcolor{red}{Duda: quÃ© funcionales mÃ¡s?}

%% Functionals PNOFi by Piris
% Reconstructionf the 2-RDM in terms of 1-RDM implies the following equality
% conditions satisfied by the $n$-representable 2-RDM are imposed
% \begin{enumerate}
%     \item Hermicity 
%     \begin{equation}
%         \sordm_{pqrs} = \sordm_{rspq}^{*},
%     \end{equation}
%     %
%     \item antisymmetry 
%     \begin{equation}
%         \sordm_{pqrs} = -\sordm_{qprs} = -\sordm_{pqsr},
%     \end{equation}
%     %
%     \item the sum rule 
%     \begin{equation}
%         \sum_{q} \sordm_{pqrq} = \left( n - 1 \right) n_p \delta_{pr},
%     \end{equation}
% \end{enumerate}
% % ---------
% \subsection{Approximate functionals}
% % ---------
% % Pag 130 del Pernal
% In the development of approximate functionals, it is convenient to search for
% approximations to the exchange-correlation term, $E_{\text{xc}}$, defined as
% \begin{equation} \label{ec:xc-functional}
%     \func{E_{\text{xc}}}{\fordm} =
%     \func{E_{\text{ee}}}{\fordm} - \func{E_{\text{H}}}{\fordm}
%     ,
% \end{equation}
% which can be decomposed into an exchange part (given in \cref{ec:xc-functional})
% and the correlation functional, $E_{\text{c}}$ 
% \begin{equation}
%     \func{E_{\text{c}}}{\fordm} =
%     \func{E_{\text{xc}}}{\fordm} - \func{E_{\text{x}}}{\fordm}
%     .
% \end{equation}
%
% \textcolor{red}{(\ldots)}

% Summary & outlook sec 6 Pernal
